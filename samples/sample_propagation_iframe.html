<!DOCTYPE html>
<html>
<head>
  <title>Sample iFrame</title>
</head>
<body>
  <script src="../lib/jquery-1.9.1.min.js"></script>
  <script type="text/javascript">
    var origin = window.location.protocol + "//" + window.location.hostname,
        port = parseInt(window.location.port),
        destinationUrl = origin + ":" + ( port - 1),
        childIframeUrl = origin + ":" + ( port + 1);
    var printMessage = function( text ) {
      var li = document.createElement('li')
          t = document.createTextNode( event.data ),
          ul = document.querySelector('ul');
      li.appendChild( t );
      ul.appendChild( li );
    };
    var loadHandler = function(){
      var messageHandler = function( messageEvent ) {
        if(messageEvent.origin === childIframeUrl) {
          messageEvent.ports[0].addEventListener('message', function( event ) {
            printMessage( event.data );
          });

          // Send a port to our parent document.
          window.parent.postMessage( 'documentAHasLoaded', destinationUrl, messageEvent.ports);
        }
      };
      if( window.addEventListener ) {
        window.addEventListener('message', messageHandler, false);
      } else {
        window.attachEvent('onmessage', messageHandler);
      }
    }

    $(document).ready( loadHandler );

    var iframe = document.createElement('iframe');
    iframe.setAttribute("src", childIframeUrl + "/samples/sample_propagation_iframe_child.html");
    document.body.appendChild( iframe );
  </script>
  <div><ul></ul></div>
</body>
</html>
